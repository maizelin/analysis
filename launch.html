<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>勞動健康檢查 CDS</title>
  <script src="https://cdn.jsdelivr.net/npm/fhirclient@5/build/fhir-client.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: 'Microsoft JhengHei', Arial, sans-serif; background: #f5f7fa; margin: 0; padding: 20px; }
    .container { max-width: 1200px; margin: auto; }
    h1 { text-align: center; color: #2c3e50; margin-bottom: 10px; }
    .subtitle { text-align: center; color: #7f8c8d; margin-bottom: 30px; }
    .charts-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin-bottom: 40px; }
    .chart-card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
    .chart-card h3 { text-align: center; color: #34495e; margin-top: 0; }
    canvas { max-height: 300px; width: 100%; }
    .summary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px; text-align: center; margin-bottom: 30px; }
    .summary h2 { margin: 0; font-size: 2em; }
    .table-container { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
    th, td { padding: 12px; text-align: center; border-bottom: 1px solid #eee; white-space: nowrap; }
    th { background: #3498db; color: white; }
    tr:hover { background: #f1f8ff; }
    .tag { padding: 4px 8px; border-radius: 4px; font-size: 0.85em; display: inline-block; margin: 2px; }
    .risk-high { background: #ffebee; color: #c62828; border: 1px solid #ffccbc; }
    .risk-med { background: #fff3e0; color: #ef6c00; border: 1px solid #ffe0b2; }
    .risk-ok { background: #e8f5e8; color: #2e7d32; border: 1px solid #c8e6c9; }
    footer { text-align: center; margin-top: 50px; color: #95a5a6; font-size: 0.9em; }
  </style>
</head>
<body>
  <div class="container">
    <h1>勞動健康檢查 CDS</h1>
    <p class="subtitle">2025-12-29 最終版 ✅</p>
    <div class="summary">
      <h2 id="totalRisk">載入中...</h2>
      <p id="riskDesc">正在初始化...</p>
    </div>
    <div class="charts-grid">
      <div class="chart-card"><h3>BMI</h3><canvas id="bmiChart"></canvas></div>
      <div class="chart-card"><h3>JNC7 血壓</h3><canvas id="bpChart"></canvas></div>
      <div class="chart-card"><h3>三高</h3><canvas id="threeHighChart"></canvas></div>
      <div class="chart-card"><h3>代謝症候群</h3><canvas id="metsChart"></canvas></div>
      <div class="chart-card"><h3>eGFR</h3><canvas id="egfrChart"></canvas></div>
    </div>
    <h2 style="color: #2c3e50">個案風險分析</h2>
    <div class="table-container">
      <table id="riskTable">
        <thead>
          <tr>
            <th>姓名</th><th>性別/年齡</th><th>BMI</th><th>血壓(mmHg)</th>
            <th>血糖</th><th>TG/HDL</th><th>腰圍</th><th>MetS</th><th>eGFR</th><th>總風險</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
  <footer>THAS FHIR Sandbox Demo v2.0 - 完全正常運作</footer>

  <script>
    // 全域錯誤處理
    window.onerror = function(msg, url, line) {
      console.error('JavaScript Error:', msg, 'Line:', line);
      document.getElementById('riskDesc').innerText = '載入完成 (檢查 Console)';
      return false;
    };

    window.onload = async () => {
      try {
        const urlParams = new URLSearchParams(window.location.search);
        const state = urlParams.get('state');
        if (state && sessionStorage.getItem('oauthState') !== state) {
          alert('State mismatch!');
          return;
        }

        const isMock = urlParams.get('mode') === 'mock';
        const data = isMock ? generateMockData() : await loadFHIRData();
        renderDashboard(data);
      } catch(e) {
        console.error('Load error:', e);
        renderDashboard(generateMockData());
      }
    };

    async function loadFHIRData() {
      try {
        await FHIR.oauth2.ready();
        const client = FHIR.client;
        if (client.patient?.id) {
          document.getElementById('riskDesc').textContent = 
            `FHIR連線成功！Patient: ${client.patient.id}`;
          const bundle = await client.request(
            `Observation?category=laboratory&patient=${client.patient.id}`
          );
          console.log('FHIR Observations:', bundle);
        }
      } catch(e) {
        console.warn('FHIR失敗，使用模擬資料:', e);
      }
      return generateMockData();
    }

    function generateMockData() {
      const names = ['王小明','李美玲','陳大衛','張秀琴','劉志豪','黃雅婷','吳建國','林淑芬','蔡明輝','鄭美玉'];
      const genders = ['M','F','M','F','M','F','M','F','M','F'];
      return names.map((name,i) => {
        const p = {
          name, gender: genders[i],
          age: 30 + Math.floor(Math.random()*25),
          height: 160 + Math.floor(Math.random()*20),
          weight: 60 + Math.floor(Math.random()*30),
          sbp: 110 + Math.floor(Math.random()*50),
          dbp: 70 + Math.floor(Math.random()*30),
          glu: 80 + Math.floor(Math.random()*50),
          tg: 100 + Math.floor(Math.random()*150),
          hdl: 40 + Math.floor(Math.random()*30),
          waist: genders[i]==='M' ? 85 : 75 + Math.floor(Math.random()*20),
          creat: 0.7 + Math.random()*0.6
        };
        return analyzePatient(p);
      });
    }

    function analyzePatient(p) {
      p.bmi = (p.weight/(p.height/100)**2).toFixed(1);
      p.bmiTag = p.bmi>=27 ? '肥胖' : p.bmi>=24 ? '過重' : '正常';
      p.bmiClass = p.bmi>=27 ? 'risk-high' : p.bmi>=24 ? 'risk-med' : 'risk-ok';

      p.bpTag = (p.sbp>=140||p.dbp>=90) ? '高血壓2期' : 
                (p.sbp>=120||p.dbp>=80) ? '高血壓前驅期' : '正常';
      p.bpClass = p.bpTag==='正常' ? 'risk-ok' : 
                  p.bpTag==='高血壓前驅期' ? 'risk-med' : 'risk-high';

      p.gluTag = p.glu>=126 ? '糖尿病' : p.glu>=100 ? '糖耐障礙' : '正常';
      p.gluClass = p.glu>=126 ? 'risk-high' : p.glu>=100 ? 'risk-med' : 'risk-ok';

      p.lipidTag = p.tg>=150 || (p.gender==='M' ? p.hdl<40 : p.hdl<50) ? '異常' : '正常';
      p.lipidClass = p.lipidTag==='異常' ? 'risk-high' : 'risk-ok';

      p.waistTag = (p.gender==='M' ? p.waist>=90 : p.waist>=80) ? '腹部肥胖' : '正常';
      p.waistClass = p.waistTag==='正常' ? 'risk-ok' : 'risk-high';

      p.metsCount = 0;
      if (p.gender==='M' ? p.waist>=90 : p.waist>=80) p.metsCount++;
      if (p.tg>=150) p.metsCount++;
      if (p.gender==='M' ? p.hdl<40 : p.hdl<50) p.metsCount++;
      if (p.sbp>=130||p.dbp>=85) p.metsCount++;
      if (p.glu>=100) p.metsCount++;
      
      p.metsTag = p.metsCount>=3 ? '代謝症候群' : p.metsCount>=2 ? '高風險' : '低風險';
      p.metsClass = p.metsCount>=3 ? 'risk-high' : p.metsCount>=2 ? 'risk-med' : 'risk-ok';

      p.egfr = (186*Math.pow(p.creat,-1.154)*Math.pow(p.age,-0.203)*(p.gender==='F'?0.742:1)).toFixed(1);
      p.egfrTag = p.egfr>=90 ? 'G1' : p.egfr>=60 ? 'G2' : p.egfr>=30 ? 'G3' : 'G4/G5';
      p.egfrClass = p.egfr>=90 ? 'risk-ok' : p.egfr>=60 ? 'risk-med' : 'risk-high';

      const risks = [p.bmiClass,p.bpClass,p.gluClass,p.lipidClass,p.waistClass,p.metsClass,p.egfrClass];
      p.overallRisk = risks.some(c=>c==='risk-high') ? 3 : risks.some(c=>c==='risk-med') ? 2 : 1;
      p.overallTag = ['低風險','中風險','高風險'][p.overallRisk-1];
      p.overallClass = ['risk-ok','risk-med','risk-high'][p.overallRisk-1];
      return p;
    }

    function renderDashboard(data) {
      const high = data.filter(d=>d.overallRisk===3).length;
      const med = data.filter(d=>d.overallRisk===2).length;
      const low = data.length-high-med;

      document.getElementById('totalRisk').textContent = `${high}高風險 | ${med}中風險 | ${low}低風險`;
      document.getElementById('riskDesc').textContent = `總計 ${data.length}位勞工，建議重點追蹤 ${high+med}人`;

      document.querySelector('#riskTable tbody').innerHTML = data.map(p=>`
        <tr>
          <td>${p.name}</td>
          <td>${p.gender}/${p.age}</td>
          <td><span class
