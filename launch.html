<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>勞動健康檢查 CDS</title>
  <script src="https://cdn.jsdelivr.net/npm/fhirclient@5/build/fhir-client.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: 'Microsoft JhengHei', Arial, sans-serif; background: #f5f7fa; margin: 0; padding: 20px; }
    .container { max-width: 1200px; margin: auto; }
    h1 { text-align: center; color: #2c3e50; margin-bottom: 10px; }
    .subtitle { text-align: center; color: #7f8c8d; margin-bottom: 30px; }
    .charts-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin-bottom: 40px; }
    .chart-card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
    .chart-card h3 { text-align: center; color: #34495e; margin-top: 0; }
    canvas { max-height: 300px; width: 100%; }
    .summary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px; text-align: center; margin-bottom: 30px; }
    .summary h2 { margin: 0; font-size: 2em; }
    .table-container { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
    th, td { padding: 12px; text-align: center; border-bottom: 1px solid #eee; white-space: nowrap; }
    th { background: #3498db; color: white; }
    tr:hover { background: #f1f8ff; }
    .tag { padding: 4px 8px; border-radius: 4px; font-size: 0.85em; display: inline-block; margin: 2px; }
    .risk-high { background: #ffebee; color: #c62828; border: 1px solid #ffccbc; }
    .risk-med { background: #fff3e0; color: #ef6c00; border: 1px solid #ffe0b2; }
    .risk-ok { background: #e8f5e8; color: #2e7d32; border: 1px solid #c8e6c9; }
    footer { text-align: center; margin-top: 50px; color: #95a5a6; font-size: 0.9em; }
  </style>
</head>
<body>
  <div class="container">
    <h1>勞動健康檢查 CDS</h1>
    <p class="subtitle">2025-12-29 部署版</p>
    <div class="summary">
      <h2 id="totalRisk">載入中...</h2>
      <p id="riskDesc">正在初始化...</p>
    </div>
    <div class="charts-grid">
      <div class="chart-card"><h3>BMI</h3><canvas id="bmiChart"></canvas></div>
      <div class="chart-card"><h3>JNC7 血壓</h3><canvas id="bpChart"></canvas></div>
      <div class="chart-card"><h3>三高</h3><canvas id="threeHighChart"></canvas></div>
      <div class="chart-card"><h3>代謝症候群</h3><canvas id="metsChart"></canvas></div>
      <div class="chart-card"><h3>eGFR</h3><canvas id="egfrChart"></canvas></div>
    </div>
    <h2 style="color: #2c3e50">個案風險分析</h2>
    <div class="table-container">
      <table id="riskTable">
        <thead><tr><th>姓名</th><th>性別/年齡</th><th>BMI</th><th>血壓(mmHg)</th><th>血糖</th><th>TG/HDL</th><th>腰圍</th><th>MetS</th><th>eGFR</th><th>總風險</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
  <footer>THAS FHIR Sandbox Demo v1.1 ✅</footer>

  <script>
    window.onload = async function() {
      const urlParams = new URLSearchParams(window.location.search);
      const returnedState = urlParams.get('state');
      if (returnedState && sessionStorage.getItem('oauthState') !== returnedState) {
        alert("State mismatch!");
        return;
      }

      const isMockMode = urlParams.get('mode') === 'mock';
      let patientsData = isMockMode ? generateMockData() : await loadFHIRData();

      renderDashboard(patientsData);
    };

    async function loadFHIRData() {
      try {
        await FHIR.oauth2.ready();
        const client = FHIR.client;
        if (client.patient?.id) {
          document.getElementById('riskDesc').innerText = `FHIR 連線成功，Patient ID: ${client.patient.id}`;
          const bundle = await client.request(`Observation?category=laboratory&patient=${client.patient.id}`);
          console.log('FHIR Data:', bundle);
          // TODO: 解析真實 FHIR Observation
        }
      } catch (e) {
        console.warn('FHIR 載入失敗，使用模擬資料');
      }
      return generateMockData();
    }

    function generateMockData() {
      const names = ['王小明', '李美玲', '陳大衛', '張秀琴', '劉志豪', '黃雅婷', '吳建國', '林淑芬', '蔡明輝', '鄭美玉'];
      const genders = ['M', 'F', 'M', 'F', 'M', 'F', 'M', 'F', 'M', 'F'];
      return names.map((name, i) => {
        const p = { name, gender: genders[i], age: 30 + Math.floor(Math.random() * 25) };
        p.height = 160 + Math.floor(Math.random() * 20);
        p.weight = 60 + Math.floor(Math.random() * 30);
        p.sbp = 110 + Math.floor(Math.random() * 50);
        p.dbp = 70 + Math.floor(Math.random() * 30);
        p.glu = 80 + Math.floor(Math.random() * 50);
        p.tg = 100 + Math.floor(Math.random() * 150);
        p.hdl = 40 + Math.floor(Math.random() * 30);
        p.waist = p.gender === 'M' ? 85 : 75 + Math.floor(Math.random() * 20);
        p.creat = 0.7 + Math.random() * 0.6;
        return analyzePatient(p);
      });
    }

    function analyzePatient(p) {
      // BMI ✅
      p.bmi = (p.weight / (p.height / 100) ** 2).toFixed(1);
      p.bmiTag = p.bmi >= 27 ? '肥胖' : p.bmi >= 24 ? '過重' : '正常';
      p.bmiClass = p.bmi >= 27 ? 'risk-high' : p.bmi >= 24 ? 'risk-med' : 'risk-ok';

      // 血壓 ✅
      p.bpTag = (p.sbp >= 140 || p.dbp >= 90) ? '高血壓2期' : 
                (p.sbp >= 120 || p.dbp >= 80) ? '高血壓前驅期' : '正常';
      p.bpClass = p.bpTag === '正常' ? 'risk-ok' : p.bpTag === '高血壓前驅期' ? 'risk-med' : 'risk-high';

      // 血糖 ✅
      p.gluTag = p.glu >= 126 ? '糖尿病' : p.glu >= 100 ? '糖耐障礙' : '正常';
      p.gluClass = p.glu >= 126 ? 'risk-high' : p.glu >= 100 ? 'risk-med' : 'risk-ok';

      // 血脂 ✅ 修正 gender → p.gender
      p.lipidTag = p.tg >= 150 || (p.gender === 'M' ? p.hdl < 40 : p.hdl < 50) ? '異常' : '正常';
      p.lipidClass = p.lipidTag === '異常' ? 'risk-high' : 'risk-ok';

      // 腰圍 ✅ 修正 gender → p.gender
      p.waistTag = (p.gender === 'M' ? p.waist >= 90 : p.waist >= 80) ? '腹部肥胖' : '正常';
      p.waistClass = p.waistTag === '正常' ? 'risk-ok' : 'risk-high';

      // MetS ✅ 修正 gender → p.gender
      p.metsCount = 0;
      if (p.gender === 'M' ? p.waist >= 90 : p.waist >= 80) p.metsCount++;
      if (p.tg >= 150) p.metsCount++;
      if (p.gender === 'M' ? p.hdl < 40 : p.hdl < 50) p.metsCount++;
      if (p.sbp >= 130 || p.dbp >= 85) p.metsCount++;
      if (p.glu >= 100) p.metsCount++;
      p.metsTag = p.metsCount >= 3 ? '代謝症候群' : p.metsCount >= 2 ? '高風險' : '低風險';
      p.metsClass = p.metsCount >= 3 ? 'risk-high' : p.metsCount >= 2 ? 'risk-med' : 'risk-ok';

      // eGFR ✅
      p.egfr = (186 * Math.pow(p.creat, -1.154) * Math.pow(p.age, -0.203) * (p.gender === 'F' ? 0.742 : 1)).toFixed(1);
      p.egfrTag = p.egfr >= 90 ? 'G1' : p.egfr >= 60 ? 'G2' : p.egfr >= 30 ? 'G3' : 'G4/G5';
      p.egfrClass = p.egfr >= 90 ? 'risk-ok' : p.egfr >= 60 ? 'risk-med' : 'risk-high';

      // 總風險
      const risks = [p.bmiClass, p.bpClass, p.gluClass, p.lipidClass, p.waistClass, p.metsClass, p.egfrClass];
      p.overallRisk = risks.some(c => c === 'risk-high') ? 3 : risks.some(c => c === 'risk-med') ? 2 : 1;
      p.overallTag = p.overallRisk === 1 ? '低風險' : p.overallRisk === 2 ? '中風險' : '高風險';
      p.overallClass = p.overallRisk === 1 ? 'risk-ok' : p.overallRisk === 2 ? 'risk-med' : 'risk-high';
      return p;
    }

    function renderDashboard(data) {
      const highRisk = data.filter(d => d.overallRisk === 3).length;
      const medRisk = data.filter(d => d.overallRisk === 2).length;
      const lowRisk = data.length - highRisk - medRisk;

      document.getElementById('totalRisk').innerText = `${highRisk}高風險 | ${medRisk}中風險 | ${lowRisk}低風險`;
      document.getElementById('riskDesc').innerText = `總計 ${data.length} 位勞工，建議重點追蹤 ${highRisk + medRisk} 人`;

      const tbody = document.querySelector('#riskTable tbody');
      tbody.innerHTML = data.map(p => `
        <tr>
          <td>${p.name}</td>
          <td>${p.gender}/${p.age}</td>
          <td><span class="tag ${p.bmiClass}">${p.bmi} ${p.bmiTag}</span></td>
          <td><span class="tag ${p.bpClass}">${p.sbp}/${p.dbp} ${p.bpTag}</span></td>
          <td><span class="tag ${p.gluClass}">${p.glu} ${p.gluTag}</span></td>
          <td><span class="tag ${p.lipidClass}">${p.tg}/${p.hdl} ${p.lipidTag}</span></td>
          <td><span class="tag ${p.waistClass}">${p.waist} ${p.waistTag}</span></td>
          <td><span class="tag ${p.metsClass}">${p.metsTag}</span></td>
          <td><span class="tag ${p.egfrClass}">${p.egfr} ${p.egfrTag}</span></td>
          <td><span class="tag ${p.overallClass}">${p.overallTag}</span></td>
        </tr>
      `).join('');
      
      drawCharts(data);
    }

    function drawCharts(data) {
      // BMI
      new Chart(document.getElementById('bmiChart'), { type: 'doughnut', data: {
        labels: ['正常(<24)', '過重(24-27)', '肥胖(≥27)'],
        datasets: [{ data: [
          data.filter(d => parseFloat(d.bmi) < 24).length,
          data.filter(d => parseFloat(d.bmi) >= 24 && parseFloat(d.bmi) < 27).length,
          data.filter(d => parseFloat(d.bmi) >= 27).length
        ], backgroundColor: ['#4bc0c0', '#ffcd56', '#ff6384'] }]
      }});

      // 血壓
      new Chart(document.getElementById('bpChart'), { type: 'bar', data: {
        labels: ['正常', '前驅期', '高血壓'],
        datasets: [{ label: '人數', data: [
          data.filter(d => d.sbp < 120 && d.dbp < 80).length,
          data.filter(d => (d.sbp >= 120 || d.dbp >= 80) && (d.sbp < 140 && d.dbp < 90)).length,
          data.filter(d => d.sbp >= 140 || d.dbp >= 90).length
        ], backgroundColor: ['#4bc0c0', '#ff9f40', '#ff6384'] }]
      }});

      // 三高 ✅ 修正邏輯
      new Chart(document.getElementById('threeHighChart'), { type: 'bar', data: {
        labels: ['高血壓', '高血糖', '血脂異常'],
        datasets: [{ label: '人數', data: [
          data.filter(d => d.sbp >= 130 || d.dbp >= 85).length,
          data.filter(d => d.glu >= 100).length,
          data.filter(d => d.lipidTag === '異常').length
        ], backgroundColor: ['#36a2eb', '#ff6384', '#ff9f40'] }]
      }});

      // MetS
      const metsCounts = Array(6).fill(0);
      data.forEach(d => metsCounts[d.metsCount > 5 ? 5 : d.metsCount]++);
      new Chart(document.getElementById('metsChart'), { type: 'line', data: {
        labels: ['0', '1', '2', '3', '4', '5+'],
        datasets: [{ label: 'MetS計數', data: metsCounts, fill: true, borderColor: '#9966ff', backgroundColor: 'rgba(153,102,255,0.2)' }]
      }});

      // eGFR
      new Chart(document.getElementById('egfrChart'), { type: 'pie', data: {
        labels: ['G1(≥90)', 'G2(60-89)', 'G3(30-59)', 'G4/G5(<30)'],
        datasets: [{ data: [
          data.filter(d => parseFloat(d.egfr) >= 90).length,
          data.filter(d => parseFloat(d.egfr) >= 60 && parseFloat(d.egfr) < 90).length,
          data.filter(d => parseFloat(d.egfr) >= 30 && parseFloat(d.egfr) < 60).length,
          data.filter(d => parseFloat(d.egfr) < 30).length
        ], backgroundColor: ['#4bc0c0', '#ffcd56', '#ff9f40', '#ff6384'] }]
      }});
    }
  </script>
</body>
</html>
