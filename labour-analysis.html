<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>勞動健康檢查 CDS</title>
  <script src="https://cdn.jsdelivr.net/npm/fhirclient@5/build/fhir-client.js"></script>
  <style>
    body {
      font-family: 'Microsoft JhengHei', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      margin: 0;
      padding: 0;
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
    }
    .container {
      text-align: center;
      background: rgba(255,255,255,0.1);
      padding: 40px;
      border-radius: 20px;
      backdrop-filter: blur(10px);
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
      max-width: 600px;
    }
    h1 {
      font-size: 2.5em;
      margin-bottom: 10px;
    }
    p {
      font-size: 1.2em;
      margin-bottom: 30px;
      opacity: 0.9;
    }
    .btn {
      display: inline-block;
      padding: 15px 30px;
      background: white;
      color: #667eea;
      font-size: 1.1em;
      font-weight: bold;
      border-radius: 50px;
      text-decoration: none;
      margin: 10px;
      transition: 0.3s;
      cursor: pointer;
    }
    .btn:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 20px rgba(0,0,0,0.2);
    }
    .quick-test {
      background: rgba(255,255,255,0.2);
      color: white;
      border: 2px solid white;
    }
    footer {
      position: absolute;
      bottom: 20px;
      font-size: 0.9em;
      opacity: 0.8;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>勞動健康檢查 CDS</h1>
    <p>BMI • 血壓 • 三高 • 代謝症候群 • eGFR 風險分析</p>
    
    <a href="javascript:void(0)" class="btn" onclick="startSmartLaunch()">
      SMART on FHIR 啟動
    </a>
    <a href="launch.html?mode=mock" class="btn quick-test">
      快速測試 (10 位模擬勞工)
    </a>
    
    <p style="margin-top: 40px; font-size: 0.9em;">
      2025-12-28<br>
      THAS FHIR Sandbox Demo
    </p>
  </div>

  <footer>THAS FHIR Sandbox</footer>

  <script>
    // SMART on FHIR PKCE Launch
    function startSmartLaunch() {
      // State (CSRF protection)
      const state = Math.random().toString(36).substring(2) + Date.now().toString(36);
      sessionStorage.setItem('oauthState', state);

      // PKCE
      function base64URLEncode(str) {
        return btoa(str).replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
      }

      const verifier = base64URLEncode(
        crypto.getRandomValues(new Uint8Array(32))
      );
      sessionStorage.setItem('code_verifier', verifier);

      crypto.subtle.digest('SHA-256', new TextEncoder().encode(verifier))
        .then(hash => {
          const challenge = base64URLEncode(
            String.fromCharCode.apply(null, new Uint8Array(hash))
          );

          FHIR.oauth2.authorize({
            clientId: "labor-health-app",
            scope: "launch openid fhirUser patient.read observation.read condition.read",
            redirectUri: "launch.html",
            iss: "https://thas.mohw.gov.tw/v/r4/fhir",
            state: state,
            codeChallenge: challenge,
            codeChallengeMethod: "S256"
          });
        });
    }
  </script>
</body>
</html>
